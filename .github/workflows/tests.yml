name: OCTO Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests-bash:
    name: Bash Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run bash unit tests
        run: bats tests/unit/bash/

  unit-tests-python:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-mock pytest-cov

      - name: Run Python unit tests
        run: |
          pytest tests/unit/python/ -v --cov=lib/core --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: python-unit
        continue-on-error: true

  unit-tests-typescript:
    name: TypeScript Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install -g typescript ts-jest jest @types/jest @types/node

      - name: Create Jest config
        run: |
          cat > jest.config.js << 'EOF'
          module.exports = {
            preset: 'ts-jest',
            testEnvironment: 'node',
            testMatch: ['**/tests/unit/typescript/**/*.ts'],
            moduleFileExtensions: ['ts', 'js'],
          };
          EOF

      - name: Run TypeScript tests
        run: jest tests/unit/typescript/ --passWithNoTests
        continue-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests-bash, unit-tests-python]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pytest pytest-mock

      - name: Setup test environment
        run: |
          chmod +x tests/helpers/*.sh
          ./tests/helpers/setup_test_env.sh

      - name: Run integration tests (bash)
        run: bats tests/integration/*.bats

      - name: Run integration tests (python)
        run: pytest tests/integration/*.py -v

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Make scripts executable
        run: |
          chmod +x bin/octo
          chmod +x lib/cli/*.sh
          chmod +x lib/watchdog/*.sh
          chmod +x tests/e2e/*.sh

      - name: Run full install E2E test
        run: ./tests/e2e/test_full_install.sh

      - name: Run bloat recovery E2E test
        run: ./tests/e2e/test_bloat_recovery.sh

  e2e-tests-docker:
    name: E2E Tests (Docker)
    runs-on: ubuntu-latest
    needs: integration-tests
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: onelist
          POSTGRES_PASSWORD: onelist_test
          POSTGRES_DB: onelist
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Make scripts executable
        run: |
          chmod +x bin/octo
          chmod +x lib/cli/*.sh
          chmod +x tests/e2e/*.sh

      - name: Run Onelist Docker E2E test
        run: ./tests/e2e/test_onelist_docker.sh
        continue-on-error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          shellcheck bin/octo lib/cli/*.sh lib/watchdog/*.sh || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python linters
        run: pip install flake8 black

      - name: Lint Python code
        run: |
          flake8 lib/core/*.py --max-line-length=120 || true
          black --check lib/core/*.py || true
